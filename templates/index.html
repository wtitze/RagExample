<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Chat Streaming</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background:#f6f6f6; 
            display:flex; 
            flex-direction:column; 
            align-items:center; 
            margin:0; 
            height:100vh; 
        }
        h1 { margin-top:20px; }
        #chat-container { 
            width:100%; 
            max-width:700px; 
            height:80%; 
            background:#fff; 
            border-radius:8px; 
            box-shadow:0 0 10px rgba(0,0,0,0.1); 
            overflow-y:auto; 
            padding:20px; 
            display:flex; 
            flex-direction:column; 
        }
        .message { 
            margin:10px 0; 
            padding:10px 15px; 
            border-radius:20px; 
            max-width:80%; 
            word-wrap:break-word; 
        }
        .user { background:#0084ff; color:#fff; align-self:flex-end; }
        .bot { background:#e5e5ea; color:#000; align-self:flex-start; }
        .source { 
            font-size:0.8em; 
            color:#555; 
            margin:5px 0 5px 20px; 
            background:#f0f0f0; 
            padding:5px 10px; 
            border-radius:12px; 
            max-width:75%; 
            word-wrap:break-word; 
            align-self:flex-start;
        }
        #input-container { display:flex; width:100%; max-width:700px; margin-top:10px; }
        #question { flex:1; padding:10px; border-radius:20px; border:1px solid #ccc; outline:none; }
        #send-btn { padding:10px 20px; margin-left:10px; border:none; border-radius:20px; background:#0084ff; color:white; cursor:pointer; }
        #send-btn:hover { background:#006bbf; }
    </style>
</head>
<body>
    <h1>RAG Chat Streaming</h1>
    <div id="chat-container"></div>
    <div id="input-container">
        <input type="text" id="question" placeholder="Scrivi la tua domanda...">
        <button id="send-btn">Invia</button>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const questionInput = document.getElementById('question');
        const sendBtn = document.getElementById('send-btn');

        function addMessage(content, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', sender);
            msgDiv.innerHTML = content;
            chatContainer.appendChild(msgDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return msgDiv;
        }

        async function sendQuestion() {
            const question = questionInput.value.trim();
            if (!question) return;

            addMessage(question, 'user');
            questionInput.value = '';

            const botMessage = addMessage('', 'bot');

            try {
                const response = await fetch('/ask_stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question })
                });

                if (!response.ok) throw new Error("Errore nella richiesta");

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let done = false;

                while (!done) {
                    const { value, done: doneReading } = await reader.read();
                    done = doneReading;
                    if (value) {
                        const chunk = decoder.decode(value);
                        if (!chunk.trim()) continue;

                        if (chunk.includes("<END_OF_ANSWER>")) {
                            botMessage.innerHTML += "<br><strong>Fonti in arrivo...</strong><br>";
                            continue;
                        }

                        if (chunk.startsWith("<SOURCE>")) {
                            const sourceText = chunk.replace("<SOURCE>", "").replace(/\n/g, "<br>");
                            const sourceDiv = document.createElement('div');
                            sourceDiv.classList.add('source');
                            sourceDiv.innerHTML = sourceText;
                            chatContainer.appendChild(sourceDiv);
                            chatContainer.scrollTop = chatContainer.scrollHeight;
                            continue;
                        }

                        // Chunk della risposta
                        botMessage.innerHTML += chunk.replace(/\n/g, "<br>");
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }
                }

            } catch (err) {
                botMessage.innerHTML += "<br><em>Errore durante il recupero della risposta.</em>";
                console.error(err);
            }
        }

        sendBtn.addEventListener('click', sendQuestion);
        questionInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendQuestion();
        });
    </script>
</body>
</html>
